<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
async function checkWalletConnection() {
    // 1. 判断登录标记
    if(sessionStorage.getItem('walletConnected') !== 'true'){
        alert("请先连接钱包！");
        window.location.href = "login.html";
        return;
    }

    // 2. 检测以太坊对象
    if(!window.ethereum){
        alert("未检测到钱包插件，请安装 MetaMask 或其他钱包！");
        window.location.href = "login.html";
        return;
    }

    try {
        const provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        const accounts = await provider.listAccounts();

        // 3. 钱包未连接
        if(accounts.length === 0){
            alert("钱包未连接，请从登录页面连接！");
            sessionStorage.removeItem('walletConnected');
            window.location.href = "login.html";
            return;
        }

        const chainId = (await provider.getNetwork()).chainId;
        // 4. 链不对（示例：只允许 Ethereum Mainnet 1）
        if(chainId !== 1){
            alert("网络错误，请切换到正确网络！");
            return;
        }

        // 5. 实时显示钱包地址
        const walletTop = document.getElementById('walletTop');
        const walletAddress = document.getElementById('walletAddress');
        walletTop.textContent = accounts[0];
        walletAddress.textContent = accounts[0];

        walletTop.onclick = () => {
            navigator.clipboard.writeText(accounts[0]);
            alert("钱包地址已复制");
        };

        // 6. 监听账户或网络变化
        window.ethereum.on('accountsChanged', (newAccounts) => {
            if(newAccounts.length === 0){
                alert("钱包已断开，请重新登录！");
                sessionStorage.removeItem('walletConnected');
                window.location.href = "login.html";
            } else {
                walletTop.textContent = newAccounts[0];
                walletAddress.textContent = newAccounts[0];
            }
        });

        window.ethereum.on('chainChanged', (chainIdHex) => {
            const newChainId = parseInt(chainIdHex, 16);
            if(newChainId !== 1){ // 主网示例
                alert("网络切换错误，请切换到正确网络！");
            }
        });

    } catch (error){
        console.error(error);
        alert("检测钱包异常，请重新登录！");
        sessionStorage.removeItem('walletConnected');
        window.location.href = "login.html";
    }
}

// 页面加载后执行
window.addEventListener('DOMContentLoaded', () => {
    checkWalletConnection();
});
</script>
